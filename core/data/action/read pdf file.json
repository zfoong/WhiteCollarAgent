{
  "_id": { "$oid": "684037650dceb231ab65491e" },
  "name": "read pdf file",
  "description": "Securely reads a PDF with Docling and returns compact, layout-aware JSON including page sizes, bboxes, text, and form-field candidates. Implements a robust fallback using pypdfium2 and pdfminer.six if Docling cannot determine page sizes or extract text.",
  "type": "atomic",
  "execution_mode": "sandboxed",
  "mode": "CLI",
  "platforms": ["windows", "linux", "darwin"],
  "input_schema": {
    "file_path": {
      "type": "string",
      "example": "C:/path/to/form.pdf",
      "description": "Local path to the PDF to read."
    }
  },
  "output_schema": {
    "status": { "type": "string", "example": "success" },
    "content": {
      "type": "object",
      "description": "Layout-aware PDF extraction output.",
      "example": {
        "document_metadata": {
          "file_name": "sample.pdf",
          "mimetype": "application/pdf",
          "docling_version": "1.7.0"
        },
        "pages": [
          { "page_number": 1, "width": 595.44, "height": 841.68 }
        ],
        "elements": [
          {
            "page_number": 1,
            "element_type": "text",
            "text": "Name:",
            "bbox_abs": { "x0": 10, "y0": 20, "x1": 100, "y1": 40, "coord_origin": "BOTTOMLEFT" },
            "bbox_norm": { "x0": 0.05, "y0": 0.02, "x1": 0.20, "y1": 0.05 },
            "is_form_field_candidate": false
          }
        ]
      }
    },
    "message": {
      "type": "string",
      "example": "File not found.",
      "description": "Only set if status = error."
    }
  },
  "scope": ["global"],
  "code": "#!/usr/bin/env python3\nimport json, sys, os, re, importlib, subprocess\nfrom typing import Any, Dict, List\n\n# -------------------\n# Safe dependency install\n# -------------------\ndef _ensure(pkg: str) -> None:\n    try:\n        importlib.import_module(pkg)\n    except ImportError:\n        subprocess.check_call([sys.executable, '-m', 'pip', 'install', pkg, '--quiet'])\n\nfor _pkg in ('docling','pypdfium2','pdfminer.six','Pillow'):\n    _ensure(_pkg)\n\nfrom docling.document_converter import DocumentConverter\nimport pypdfium2\nfrom pdfminer.high_level import extract_text\n\nSAFE_EXTS = {'.pdf'}\nMAX_FILE_SIZE_MB = 50\n_FIELD_RE = re.compile(r'(?:_{4,}|\\.{4,}|—{3,}|–{3,})')\n\n# Helper functions\ndef _json(status, message='', content=None):\n    return json.dumps({'status': status, 'message': message, 'content': content or ''}, ensure_ascii=False)\n\ndef _is_form_blank(text):\n    if not text:\n        return False\n    return bool(_FIELD_RE.search(text.strip()))\n\ndef _to_safe_int(v):\n    if isinstance(v, int):\n        if v > 9223372036854775807 or v < -9223372036854775808:\n            return str(v)\n    return v\n\ndef _deep_sanitize(o):\n    if isinstance(o, dict):\n        return {k: _deep_sanitize(_to_safe_int(v)) for k, v in o.items()}\n    if isinstance(o, list):\n        return [_deep_sanitize(_to_safe_int(v)) for v in o]\n    return _to_safe_int(o)\n\n# Page extraction with fallback\ndef _extract_pages(raw, src):\n    pages = raw.get('pages') if raw else []\n    out = []\n\n    if isinstance(pages, list):\n        for p in pages:\n            size = p.get('size') or {}\n            out.append({'page_number': p.get('page_no') or p.get('number'), 'width': size.get('width'), 'height': size.get('height')})\n    elif isinstance(pages, dict):\n        for k in sorted(pages.keys(), key=lambda x: int(x) if str(x).isdigit() else str(x)):\n            p = pages[k]\n            size = p.get('size') or {}\n            out.append({'page_number': p.get('page_no') or p.get('number') or int(k), 'width': size.get('width'), 'height': size.get('height')})\n\n    needs_fallback = any(p['width'] in (None,0) or p['height'] in (None,0) for p in out) or not out\n    if needs_fallback:\n        try:\n            pdf = pypdfium2.PdfDocument(src)\n            if not out:\n                out = [{'page_number': i+1, 'width': None, 'height': None} for i in range(len(pdf))]\n            for idx, p in enumerate(out):\n                page = pdf.get_page(idx)\n                w, h = page.get_size()\n                if not p['width']:\n                    p['width'] = float(w)\n                if not p['height']:\n                    p['height'] = float(h)\n        except Exception:\n            out = [{'page_number': i+1, 'width': 612, 'height': 792} for i in range(len(out) or 1)]\n    return out\n\n# Map page dimensions\ndef _page_dims_map(pages):\n    out = {}\n    for p in pages:\n        pn = p.get('page_number')\n        if isinstance(pn, int) and p.get('width') and p.get('height'):\n            out[pn] = {'w': float(p['width']), 'h': float(p['height'])}\n    return out\n\n# Bbox helpers\ndef _bbox_abs_from_docling(bbox):\n    return {'x0': float(bbox.get('l',0)),'y0': float(bbox.get('b',0)),'x1': float(bbox.get('r',0)),'y1': float(bbox.get('t',0)),'coord_origin': str(bbox.get('coord_origin') or 'BOTTOMLEFT')}\n\ndef _norm_bbox(absb, w, h):\n    return {'x0': max(0, min(1, absb['x0']/w)),'y0': max(0, min(1, absb['y0']/h)),'x1': max(0, min(1, absb['x1']/w)),'y1': max(0, min(1, absb['y1']/h))}\n\n# Extract elements\ndef _extract_elements(raw, dims, src):\n    out = []\n    texts = raw.get('texts') if raw else []\n\n    if not texts:\n        try:\n            full_text = extract_text(src)\n            for i, line in enumerate(full_text.splitlines()):\n                page_no = 1\n                w,h = dims[page_no]['w'], dims[page_no]['h']\n                abs_bbox = {'x0':0,'y0':i*10,'x1':w,'y1':(i+1)*10,'coord_origin':'BOTTOMLEFT'}\n                norm = _norm_bbox(abs_bbox,w,h)\n                out.append({'page_number':page_no,'element_type':'text','text':line.strip(),'bbox_abs':abs_bbox,'bbox_norm':norm,'is_form_field_candidate':_is_form_blank(line)})\n        except Exception:\n            pass\n        return out\n\n    for t in texts:\n        text_val = t.get('text') or t.get('orig')\n        label = t.get('label') or t.get('type') or 'text'\n        prov = t.get('prov')\n        if not (isinstance(prov,list) and prov):\n            continue\n        p0 = prov[0]\n        page_no = p0.get('page_no')\n        bbox = p0.get('bbox')\n        if page_no is None or not isinstance(bbox, dict) or int(page_no) not in dims:\n            continue\n        d = dims[int(page_no)]\n        abs_bbox = _bbox_abs_from_docling(bbox)\n        norm = _norm_bbox(abs_bbox,d['w'],d['h'])\n        out.append({'page_number':int(page_no),'element_type':label,'text':text_val,'bbox_abs':abs_bbox,'bbox_norm':norm,'is_form_field_candidate':_is_form_blank(text_val)})\n    return out\n\n# Main execution\ndef _execute():\n    global output\n    try:\n        input_data = globals().get('input_data',{})\n        src = str(input_data.get('file_path','')).strip()\n        if not src:\n            output = _json('error',\"'file_path' is required.\"); return\n        if '..' in src.replace('\\\\','/'):\n            output = _json('error','Invalid file path.'); return\n        if not os.path.isfile(src):\n            output = _json('error','File does not exist.'); return\n        if not os.access(src, os.R_OK):\n            output = _json('error','File is not readable.'); return\n        ext = os.path.splitext(src)[1].lower()\n        if ext not in SAFE_EXTS:\n            output = _json('error',f\"Unsupported file type '{ext}'. Only PDF allowed.\"); return\n        size_mb = os.path.getsize(src)/(1024*1024)\n        if size_mb > MAX_FILE_SIZE_MB:\n            output = _json('error',f'File too large ({size_mb:.1f} MB). Max {MAX_FILE_SIZE_MB} MB.'); return\n\n        raw = None\n        try:\n            conv = DocumentConverter()\n            result = conv.convert(src)\n            if result.status=='success':\n                raw = result.document.export_to_dict()\n        except Exception:\n            pass\n\n        pages = _extract_pages(raw,src)\n        dims = _page_dims_map(pages)\n        elements = _extract_elements(raw,dims,src)\n\n        origin = raw.get('origin') if raw else {}\n        meta = {'file_name':origin.get('filename') or os.path.basename(src),'mimetype':origin.get('mimetype') or 'application/pdf','docling_version':raw.get('version') if raw else None}\n\n        payload = {'document_metadata':_deep_sanitize(meta),'pages':_deep_sanitize(pages),'elements':_deep_sanitize(elements)}\n\n        output = _json('success','PDF extracted successfully.',payload)\n    except Exception as e:\n        output = _json('error', str(e))\n\n_execute()"
}

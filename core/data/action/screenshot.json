{
  "_id": { "$oid": "688c546d12c6041305c2b1c4" },
  "name": "screenshot",
  "description": "Takes a screenshot of the agent screen.",
  "type": "atomic",
  "execution_mode": "sandboxed",
  "mode": "ALL",
  "platforms": ["windows", "linux", "darwin"],
  "input_schema": {
    "output_path": {
      "type": "string",
      "example": "C:\\\\Users\\\\user\\\\Pictures\\\\screenshot.png",
      "description": "Optional absolute file path for the screenshot. If omitted, a timestamped PNG is saved in the workspace root."
    },
    "format": {
      "type": "string",
      "example": "png",
      "description": "Image format: \"png\" or \"jpg\". Defaults to \"png\"."
    }
  },
  "output_schema": {
    "status": { "type": "string", "example": "success" },
    "file_path": { "type": "string", "example": "C:\\\\Users\\\\user\\\\Pictures\\\\screenshot.png" },
    "message": { "type": "string", "example": "Unable to capture screen." }
  },
  "scope": ["global"],
  "code": "import json, os, sys, subprocess, importlib, time\nfrom datetime import datetime\n\n# Install required packages\ndef _ensure(pkg):\n    try:\n        importlib.import_module(pkg)\n    except ImportError:\n        subprocess.check_call([sys.executable, '-m', 'pip', 'install', pkg, '--quiet'])\n\nfor pkg in (\"mss\", \"Pillow\"):\n    _ensure(pkg)\n\nimport mss\nfrom PIL import Image\n\n# Inputs\noutput_path = str(input_data.get('output_path','')).strip()\nfmt = str(input_data.get('format','png')).lower()\nif fmt not in ('png','jpg','jpeg'):\n    fmt='png'\n\nif not output_path:\n    root = os.getenv('AGENT_WORKSPACE_ROOT', os.getcwd())\n    ts = datetime.utcnow().strftime('%Y%m%d_%H%M%S')\n    output_path = os.path.join(root, f\"screenshot_{ts}.{fmt}\")\n\n# Helper: MSS\ndef try_mss():\n    try:\n        with mss.mss() as sct:\n            mon = sct.monitors[1] if len(sct.monitors) > 1 else sct.monitors[0]\n            shot = sct.grab(mon)\n            img = Image.frombytes('RGB', shot.size, shot.rgb)\n            img.save(output_path, fmt.upper())\n        return True\n    except Exception:\n        return False\n\n# Helper: sudo command execution\nsudo_prefix = ['sudo', '-n']  # -n prevents password prompt\n\ndef try_sudo(cmd_list):\n    try:\n        subprocess.check_call(sudo_prefix + cmd_list, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)\n        return True\n    except Exception:\n        return False\n\n# OS detection\nis_wayland = bool(os.getenv('WAYLAND_DISPLAY'))\n\ntry:\n    # ===== WAYLAND =====\n    if is_wayland:\n        pics = os.path.expanduser('~/Pictures')\n        before = set(os.listdir(pics)) if os.path.isdir(pics) else set()\n\n        # 1. xdg-desktop-portal\n        try:\n            subprocess.run([\n                'dbus-send','--session',\n                '--dest=org.freedesktop.portal.Desktop',\n                '--type=method_call',\n                '/org/freedesktop/portal/desktop',\n                'org.freedesktop.portal.Screenshot.Screenshot',\n                'dict:string:string:()', 'string:\"\"'\n            ], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)\n        except Exception:\n            pass\n\n        time.sleep(1.8)\n        after = set(os.listdir(pics)) if os.path.isdir(pics) else set()\n        new_files = list(after - before)\n        if new_files:\n            latest = max([os.path.join(pics,f) for f in new_files], key=os.path.getmtime)\n            os.replace(latest, output_path)\n            output = json.dumps({'status':'success','file_path':output_path,'message':'portal'})\n            sys.exit(0)\n\n        # 2. grim\n        try:\n            png_bytes = subprocess.check_output(['grim','-'], stderr=subprocess.DEVNULL)\n            with open(output_path,'wb') as f: f.write(png_bytes)\n            output = json.dumps({'status':'success','file_path':output_path,'message':'grim'})\n            sys.exit(0)\n        except Exception:\n            pass\n\n        # 3. sudo grim\n        if try_sudo(['grim', output_path]):\n            output = json.dumps({'status':'success','file_path':output_path,'message':'sudo grim'})\n            sys.exit(0)\n\n        # 4. MSS fallback\n        if try_mss():\n            output = json.dumps({'status':'success','file_path':output_path,'message':'mss fallback'})\n            sys.exit(0)\n\n        # 5. sudo MSS\n        if try_sudo([sys.executable, '-c', f'import mss; import PIL.Image; ' \\\n                      f'mss_instance=mss.mss(); img=mss_instance.grab(mss_instance.monitors[1]); ' \\\n                      f'Image.frombytes(\"RGB\", img.size, img.rgb).save(\"{output_path}\", \"{fmt.upper()}\")']):\n            output = json.dumps({'status':'success','file_path':output_path,'message':'sudo mss'})\n            sys.exit(0)\n\n        raise RuntimeError('Wayland blocked screenshot (all methods failed)')\n\n    # ===== X11 =====\n    if try_mss():\n        output = json.dumps({'status':'success','file_path':output_path,'message':'mss'})\n        sys.exit(0)\n\n    raise RuntimeError('Unable to capture screen (X11)')\n\nexcept Exception as e:\n    output = json.dumps({'status':'error','file_path':'','message':str(e)})",
  "platform_overrides": {
    "windows": {
      "code": "import json, os, sys, subprocess, importlib\nfrom datetime import datetime\n\ndef _ensure(pkg):\n    try: importlib.import_module(pkg)\n    except ImportError: subprocess.check_call([sys.executable, '-m', 'pip', 'install', pkg, '--quiet'])\nfor pkg in ('mss','Pillow'): _ensure(pkg)\n\nimport mss\nfrom PIL import Image\n\noutput_path = str(input_data.get('output_path','')).strip()\nfmt = str(input_data.get('format','png')).lower()\nif fmt not in ('png','jpg','jpeg'): fmt='png'\n\nif not output_path:\n    root=os.getenv('AGENT_WORKSPACE_ROOT',os.getcwd())\n    ts=datetime.utcnow().strftime('%Y%m%d_%H%M%S')\n    output_path=os.path.join(root,f'screenshot_{ts}.{fmt}')\n\ntry:\n    with mss.mss() as sct:\n        mon = sct.monitors[1] if len(sct.monitors)>1 else sct.monitors[0]\n        shot = sct.grab(mon)\n        img = Image.frombytes('RGB', shot.size, shot.rgb)\n        img.save(output_path, fmt.upper())\n    output = json.dumps({'status':'success','file_path':output_path,'message':'mss'})\nexcept Exception as e:\n    output = json.dumps({'status':'error','file_path':'','message':str(e)})"
    },
    "darwin": {
      "code": "import json, os, sys, subprocess, importlib\nfrom datetime import datetime\n\ndef _ensure(pkg):\n    try: importlib.import_module(pkg)\n    except ImportError: subprocess.check_call([sys.executable,'-m','pip','install',pkg,'--quiet'])\nfor pkg in ('mss','Pillow'): _ensure(pkg)\n\nimport mss\nfrom PIL import Image\n\noutput_path=str(input_data.get('output_path','')).strip()\nfmt=str(input_data.get('format','png')).lower()\nif fmt not in ('png','jpg','jpeg'): fmt='png'\n\nif not output_path:\n    root=os.getenv('AGENT_WORKSPACE_ROOT',os.getcwd())\n    ts=datetime.utcnow().strftime('%Y%m%d_%H%M%S')\n    output_path=os.path.join(root,f'screenshot_{ts}.{fmt}')\n\n# 1. Try MSS\ntry:\n    with mss.mss() as sct:\n        mon = sct.monitors[1] if len(sct.monitors) > 1 else sct.monitors[0]\n        shot = sct.grab(mon)\n        img = Image.frombytes('RGB', shot.size, shot.rgb)\n        img.save(output_path, fmt.upper())\n    output = json.dumps({'status':'success','file_path':output_path,'message':'mss'})\n    sys.exit(0)\nexcept Exception:\n    pass\n\n# 2. macOS native fallback\ntry:\n    subprocess.check_call(['screencapture', output_path], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)\n    output = json.dumps({'status':'success','file_path':output_path,'message':'screencapture'})\nexcept Exception as e:\n    output = json.dumps({'status':'error','file_path':'','message':str(e)})"
    }
  }
}

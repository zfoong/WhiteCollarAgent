name: PDF splitting
description: Split one or more multi-page PDF files into smaller PDF documents according to simple rules (by page ranges, fixed pages per chunk, or per-page), using an efficient CLI-based Python script. Keep the original files unchanged and write outputs into a specified folder.

goal/outcome:
  - One or more source PDF files ({source_pdf_paths} or all *.pdf under {source_directory}) are split into smaller PDF documents as requested.
  - Splitting rules (e.g., fixed {pages_per_chunk}, explicit {page_ranges}, or "one file per page") are applied consistently across all selected PDFs.
  - Original PDFs remain unchanged unless the user explicitly asks to remove them.
  - All output PDFs are written to {output_directory} using a clear naming pattern (e.g., {base_name}_part_{index}.pdf or {base_name}_pages_{start}-{end}.pdf).
  - A simple log file {log_path} exists in the workspace, mapping each source PDF and its pages to the generated output files with status.
  - The user receives a concise summary: which PDFs were processed, how many output files were created, where they were saved, and the log file location.

inputs_params:
  - Required: Source PDFs specification, either:
    - Explicit file paths: {source_pdf_paths}, or
    - A directory + pattern: {source_directory} (e.g., "all PDFs in this folder").
  - Required: Splitting rule, such as:
    - Fixed pages per chunk: {pages_per_chunk} (e.g., 10 pages per output),
    - One output per page,
    - Explicit page ranges: {page_ranges} (e.g., "1-3,4-7,8-10"),
    - Or “split at these pages” (e.g., split after pages 3, 7, 12).
  - Required: Output directory path: {output_directory} (can be created if it does not exist).
  - Optional: Output naming pattern: {output_name_pattern}
    - Example: "{base_name}_part_{index}.pdf" or "{base_name}_pages_{start}-{end}.pdf".
  - Optional: Whether to recurse into subdirectories when a source directory is given (recursive: true/false).
  - Optional: Whether to remove original PDFs after successful splitting (default: keep originals).
  - Optional: Safety limit on total pages or number of output files (e.g., {max_output_files}) to avoid excessive splitting.

context:
  reasoning:
    - Keep the workflow straightforward:
      - Confirm which PDFs to process and how to split them.
      - Run a single "create and run python script" to locate PDFs, split them using a PDF library (installed within the script), and log results.
      - Do a quick, count-based validation and report to the user.
    - Prefer CLI-only operations with "create and run python script"; no GUI actions are needed.
    - In the script:
      - Use base Python plus a small pip-installed library (e.g., PyPDF2 or pypdf) to read and write PDFs.
      - For each source PDF:
        - Open it once, compute its total page count, and derive segments based on the splitting rule.
        - For each segment, create a new PDF with those pages in order.
      - Apply the output naming pattern consistently; if none is given, fall back to "{base_name}_part_{index}.pdf".
      - Avoid overwriting: if an output file name already exists in {output_directory}, append a simple suffix like "_1", "_2".
      - Append log entries for each output (source, pages, output file path, status, error_message).
    - Use a safety cap if the splitting rule would generate a very large number of output files; if reached, stop and inform the user.
    - Originals remain untouched unless explicitly requested; deletion of originals is a simple optional step at the end of the script.
  deadline: {time_left} left until deadline {deadline}
  definition_of_done(check during final validation step):
    - All specified source PDFs have been processed, or clear errors are logged for any that failed.
    - For each successfully processed PDF:
      - The total number of pages in the original equals the sum of pages across its outputs (no missing or duplicated pages).
      - Output files exist in {output_directory} with the expected naming pattern (or default pattern).
    - No existing unrelated files in {output_directory} were modified or overwritten.
    - A log file {log_path} exists, including at least: source_pdf, output_pdf, page_start, page_end, status, error_message.
    - The user receives a short summary message with:
      - The count of source PDFs processed.
      - Total output files created.
      - Any files that failed to process.
      - The path to {output_directory} and {log_path}.
  avoid:
    - Scanning huge directory trees without user intent; keep the search to {source_directory} and optionally its subdirectories when requested.
    - Changing or deleting original PDFs unless the user specifically asks for it.
    - Overly complex rules (nested conditions, multiple passes). A single script and a clear rule are enough.
    - Overwriting existing output files without changing the name.
    - Using GUI mode; it’s not needed.

steps:
  name: Confirm PDFs and splitting rule
  description: Ensure the agent knows exactly which PDFs to split, how to split them, where to save outputs, and whether to keep or remove originals.
  action_instruction: >
    Use "send_message" to restate and confirm the key parameters with the user:
    - Source PDFs: either explicit paths ({source_pdf_paths}) or a single directory {source_directory}
      (optionally with recursion into subfolders).
    - Splitting rule: one of:
      - fixed pages per chunk (e.g., {pages_per_chunk}),
      - one file per page,
      - explicit page ranges (e.g., {page_ranges}),
      - or split after specific pages (e.g., {split_after_pages}).
    - Output directory: {output_directory} (ask whether to create it if it does not exist).
    - Output naming pattern: {output_name_pattern}, or confirm default "{base_name}_part_{index}.pdf".
    - Whether to keep or delete original PDFs after successful splitting.
    - Any safety limit (e.g., "stop if more than {max_output_files} outputs would be created").
    If any of these are unclear or missing, use "send_message" with a focused question (for example,
    "Should I split {source_pdf_path} into one file per page, or into chunks of {pages_per_chunk} pages?").
    Once clarified, send a brief "send_message" summarizing the final agreed parameters so they are explicit.
  validation_instruction: >
    Before proceeding:
    - Check that at least one source specification is provided (either {source_pdf_paths} or {source_directory}).
    - Check that the splitting rule is concrete (e.g., pages_per_chunk is a positive integer, page_ranges are valid strings).
    - Check that {output_directory} is defined.
    - If deletion of originals is requested, double-check with the user in the confirmation summary.
    If any required element is missing or ambiguous, do not continue; ask again using "send_message".

  name: Locate source PDFs (if using directory)
  description: When a directory is given instead of explicit paths, resolve which PDF files to process.
  action_instruction: >
    If source PDFs are already given as explicit paths {source_pdf_paths}, you can skip this step and proceed to splitting.
    If a directory {source_directory} is given:
      - Use "create and run python script" to:
        - Check that {source_directory} exists and is a directory.
        - If recursive is true, walk subdirectories with os.walk; otherwise, only list files in {source_directory}.
        - Collect all files ending with ".pdf" (case-insensitive).
        - Apply any simple include/exclude rules if the user specified them (for example, only files whose names match {name_filter}).
        - Print to stdout:
          - The number of PDFs found.
          - A short sample of file names (e.g., first 5).
      - Use the resulting list as the internal set {resolved_source_pdfs}.
  validation_instruction: >
    Check the script output:
    - If zero PDFs are found, send a "send_message" telling the user that no PDFs were discovered under {source_directory}
      and ask whether to adjust the directory or stop.
    - If one or more PDFs are found, proceed and treat them as {resolved_source_pdfs}.
    - If the directory does not exist or cannot be read, inform the user and ask for a corrected path or decide to cancel.

  name: Split PDFs in one script and log results
  description: Use a single Python script to open each source PDF, apply the splitting rule, write output PDFs, and record a log.
  action_instruction: >
    Use "create and run python script" with a script that:
    - Accepts:
      - a list of source PDFs ({source_pdf_paths} or {resolved_source_pdfs}),
      - {output_directory},
      - splitting rule parameters ({pages_per_chunk}, {page_ranges}, {split_mode}, etc.),
      - {output_name_pattern},
      - a flag {delete_originals} (True/False),
      - {max_output_files} or similar safety cap,
      - a log file path {log_path} (e.g., "pdf_split_log_{date_time}.csv").
    - Inside the script:
      - Import subprocess and install a small PDF library if needed (e.g., pypdf) using pip.
      - For each source PDF:
        - Open the file with the PDF library.
        - Determine total_pages.
        - Derive a list of (start_page, end_page) segments based on the splitting rule:
          - For fixed chunks: [1–pages_per_chunk], [pages_per_chunk+1–2*pages_per_chunk], etc.
          - For per-page: (1–1), (2–2), ..., (total_pages–total_pages).
          - For explicit ranges: parse {page_ranges}.
        - If a safety cap {max_output_files} exists and the total outputs across all PDFs would exceed it, stop and mark the excess as skipped, noting this in stdout and the log.
        - For each segment:
          - Create a new PDF writer.
          - Copy pages from source into the new document for that segment.
          - Build an output file name using:
            - base_name (source filename without extension),
            - {output_name_pattern} or default "{base_name}_pages_{start}-{end}.pdf".
          - If a file with that name already exists in {output_directory}, append a suffix like "_1", "_2".
          - Write the output PDF.
          - Add a log entry: source_pdf, output_pdf, page_start, page_end, status="created", error_message="".
      - After processing a source PDF:
        - If {delete_originals} is True and all its segments were successfully written, delete the original file and log a final entry indicating "original_deleted".
      - Write all log entries to {log_path} (CSV or delimited text).
      - Print to stdout:
        - Number of source PDFs processed.
        - Total pages processed.
        - Total output files created.
        - Any skipped outputs due to safety limits or errors.
        - The {log_path} and {output_directory}.
  validation_instruction: >
    Check the action output:
    - Confirm the script ran successfully (no unhandled exception in stderr).
    - Confirm that stdout shows:
      - A non-zero number of processed PDFs (if the user expected some).
      - The path to {log_path} and {output_directory}.
    - If the script reports that safety limits were hit or some PDFs failed, note this for the final summary.
    There is no need for a second pass; rely on the log and counts for validation.

  name: Overall validate splitting results
  description: Do a quick consistency check using the log file to ensure the task meets the definition_of_done.
  action_instruction: >
    Use either "shell view" on {log_path} or a tiny "create and run python script" to:
      - Count how many lines have status="created".
      - Optionally check that each source_pdf appearing in the log has at least one output entry.
      - Count any lines with error_message not empty.
    Verify that:
      - The number of outputs created is reasonable (not zero unless the user expected it).
      - Errors are present only for specific problem files and are clearly recorded.
    If the log or counts look obviously wrong (e.g., zero created outputs while the script claimed success), inform the user via "send_message" and, if necessary, mark the task as error or rerun after user guidance.
  # Simple log-based validation is sufficient; no extra PDF reads are needed here.

  name: Close task and report to user
  description: Summarize what was done, provide key paths, and mark the task status.
  action_instruction: >
    Use "send_message" to provide a short final summary:
    - Source PDFs processed (either list a few names or the directory {source_directory}).
    - Splitting rule used (pages_per_chunk, per-page, or page_ranges, etc.).
    - Whether originals were preserved or deleted.
    - Total output files created and total pages processed (as reported by the script).
    - Any notable errors (e.g., specific PDFs that failed).
    - The output directory {output_directory} and log file {log_path}.
    If the task met the definition_of_done:
      - Call "mark task completed" with a concise message that references the number of outputs and {output_directory}.
    If the user canceled or changed their mind before splitting:
      - Call "mark task cancel" with the reason.
    If processing failed in a way that prevented meaningful splitting:
      - Call "mark task error" with a brief explanation and include {log_path} so the user can inspect details.

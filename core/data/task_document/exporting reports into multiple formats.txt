name: Exporting reports into multiple formats
description: From a single source report, generate consistent exports in one or more formats (PDF, presentation slides, spreadsheet) with shared content, metadata, and naming, and save them in the agent workspace.

goal/outcome:
  - A single canonical version of the report content (e.g., Markdown) is established as the source of truth.
  - All requested output formats are generated from the same canonical content:
    - PDF report: {output_basename}.pdf
    - Slides: {output_basename}.pptx
    - Spreadsheet: {output_basename}.xlsx or {output_basename}.csv
  - Each exported file includes consistent title, main sections, and basic metadata (e.g., {report_title}, {date_time}).
  - All generated files are saved under {output_directory} in the agent workspace.
  - A small log/summary text file exists listing formats produced, file paths, and status.
  - The user receives a concise summary with the list of exported files and where to find them.

inputs_params:
  - Required: Source content reference:
    - Path to an existing file (e.g., {source_md_file}, {source_docx_file}, {source_txt_file}), or
    - Direct text provided by the user.
  - Required: Target formats to generate (one or more of): pdf, slides, spreadsheet.
  - Required: Base report name and title:
    - {output_basename} (used for filenames).
    - {report_title} (used as display title inside outputs).
  - Optional: Output directory in workspace (default: {workspace_dir}/exports/{output_basename}).
  - Optional: Slide preferences:
    - Basic slide layout rule, e.g., “one section per slide” or “title + bullets only”.
  - Optional: Spreadsheet preferences:
    - Columns to include (e.g., Section, Summary, WordCount).
  - Optional: Date/time format to embed in document metadata or filename suffix (e.g., _{date_YYYYMMDD}).

context:
  reasoning:
    - Use a simple pipeline: confirm inputs → normalize content once → generate all requested formats from that canonical content → log and summarize.
    - Prefer CLI mode with "create and run python script" and built-in file actions; no GUI is needed.
    - Normalize the source into one Markdown file {canonical_md_path} if it is not already in Markdown:
      - If source is .md, use it directly.
      - If source is .docx or .txt, use "clean_to_md" (or a small Python script) to produce Markdown.
    - For PDF:
      - Use the canonical Markdown and "convert_to_pdf" or "create pdf file" to generate a PDF.
    - For slides and spreadsheet:
      - Use a single "create and run python script" where possible, installing minimal libraries if needed (e.g., python-pptx, openpyxl or using csv).
    - Keep the number of actions low:
      - At most: one normalization step, one export script, and specific actions for PDF conversion and logging.
    - After generation, do simple existence/size checks on the output files and log the results.
  deadline: {time_left} left until deadline {deadline}
  definition_of_done(check during final validation step):
    - A canonical Markdown file exists for the report at {canonical_md_path}.
    - For each format requested by the user:
      - The expected output file exists at the correct path in {output_directory}.
      - The file is non-empty (basic size check).
    - A short log/summary file exists (e.g., {output_directory}/{output_basename}_export_log.txt) listing:
      - Source used.
      - Formats requested and generated.
      - Paths of each generated file.
      - Any errors or skipped formats.
    - The user has been sent a summary message with:
      - The formats produced.
      - Exact paths to each file and the log.
  avoid:
    - Rewriting or re-entering the report content separately for each format.
    - Performing multiple normalization passes (normalize once, then reuse).
    - Using GUI mode or complex multi-step workflows when a single script can generate several formats.
    - Installing unnecessary libraries; only install what is needed for the requested formats.
    - Creating outputs with inconsistent titles or sections across formats.

steps:
  name: Confirm source and formats
  description: Ensure the agent knows where the report content comes from, which formats to generate, and basic naming/output preferences.
  action_instruction: >
    Use the "send_message" action to confirm:
    - The source content:
      - Either a file path {source_file_path} (e.g., .md, .docx, .txt),
      - Or text that the user wants treated as the report content.
    - Requested formats: a list from {pdf, slides, spreadsheet}.
    - {output_basename} and {report_title}.
    - Desired {output_directory} (or confirm a default such as {workspace_dir}/exports/{output_basename}).
    - Optional preferences:
      - Slide style (e.g., one section per slide).
      - Spreadsheet columns (e.g., Section, Summary).
      - Whether to add a date/time suffix to filenames (e.g., _{date_YYYYMMDD}).
    If any key detail is missing (e.g., which formats, source file path, or output_basename),
    use the "send_message" action with a short, specific question (for example,
    "Which formats do you want? (pdf, slides, spreadsheet)"). Once clarified, send a brief "send_message"
    that summarizes the final parameters so they are clearly recorded.
  validation_instruction: >
    Confirm that:
    - {source_file_path} or inline content is clearly defined.
    - There is at least one requested format.
    - {output_basename} is non-empty.
    - {output_directory} is known or a default has been accepted.
    If any of these are not confirmed, ask again using "send_message" and do not proceed until they are clear.

  name: Normalize source content to canonical Markdown
  description: Convert the source content into a single canonical Markdown file {canonical_md_path} that will be used for all exports.
  action_instruction: >
    Choose the simplest path based on {source_file_path}:
    - If the user provides Markdown directly (file ends with .md or inline markdown content):
      - If it is a file, set {canonical_md_path} = {source_md_file} and reuse it.
      - If it is inline content, create a new file at {canonical_md_path} using "create text file"
        with {file_content} set to the provided markdown.
    - If the user provides a .docx file:
      - Use "read word file" with {file_path} = {source_docx_file} to extract text.
      - Save that text to a temporary .txt or .md file using "create text file".
      - Optionally run "clean_to_md" on the intermediate text file to produce {canonical_md_path} as clean Markdown.
    - If the user provides a .txt-like file:
      - Use "clean_to_md" on {source_txt_file} to produce {canonical_md_path}.
    Make sure {canonical_md_path} is inside {output_directory} (e.g., {output_directory}/{output_basename}.md}).
  validation_instruction: >
    Check that:
    - The normalization actions return a success status.
    - {canonical_md_path} is set and points to an existing file path within {output_directory}.
    - The file is non-empty (for example, by using "shell exec" to get its size or "shell view" to inspect its head).
    If normalization fails (file not found, unreadable, or empty content), send a short "send_message" explaining the issue
    and either ask for a corrected source or "mark task error" if it cannot be recovered.

  name: Export PDF from canonical Markdown
  description: If PDF is requested, generate a PDF report from the canonical Markdown content and save it under {output_directory}.
  action_instruction: >
    If "pdf" is in the requested formats:
      - Decide the PDF file path, e.g., {output_directory}/{output_basename}.pdf or
        {output_directory}/{output_basename}_{date_YYYYMMDD}.pdf if a date suffix is requested.
      - Use "convert_to_pdf" with:
        - input_file = {canonical_md_path}
        - output_pdf = {pdf_file_path}
      - Alternatively, if "convert_to_pdf" is not suitable, read the canonical Markdown in a small
        "create and run python script" and then call "create pdf file" using the content and target path.
    If "pdf" is not requested, skip this step.
  validation_instruction: >
    If PDF was requested:
      - Confirm the PDF action reports success.
      - Optionally use "shell exec" or "shell view" to verify that {pdf_file_path} exists and has a non-zero size.
    If PDF creation fails, log the error reason (for the log file in a later step) and notify the user via "send_message"
    that the PDF could not be produced while other formats may still succeed.

  name: Export slides and spreadsheet via script
  description: Use a single Python script to generate presentation slides (.pptx) and/or a spreadsheet (.xlsx or .csv) from the canonical Markdown, depending on what formats were requested.
  action_instruction: >
    If "slides" or "spreadsheet" are in the requested formats, use "create and run python script" with code that:
      - Reads the content of {canonical_md_path}.
      - Parses the content into simple sections, for example:
        - Lines starting with "# " as main sections.
        - Lines starting with "## " or lower headings as subpoints/bullets.
      - If "slides" is requested:
        - Install python-pptx if needed using subprocess (pip install python-pptx).
        - Create a .pptx file at {slides_file_path} such as {output_directory}/{output_basename}.pptx.
        - Add a title slide using {report_title} and {date_time}.
        - For each main section, create a slide with:
          - Title: section heading text.
          - Bullet points: key lines or summarized content from that section.
      - If "spreadsheet" is requested:
        - Either:
          - Install openpyxl and create an .xlsx file, or
          - Write a .csv file using the standard library.
        - Use simple columns such as: SectionTitle, Summary, WordCount.
        - For each main section, add a row with section heading, a short summary (first N characters or first paragraph),
          and word count of the section.
        - Save the spreadsheet as {spreadsheet_file_path}, e.g., {output_directory}/{output_basename}.xlsx or .csv.
      - Print to stdout which formats were generated and their paths.
  validation_instruction: >
    If "slides" was requested:
      - Confirm that {slides_file_path} was created successfully and has non-zero size.
    If "spreadsheet" was requested:
      - Confirm that {spreadsheet_file_path} was created successfully and has non-zero size.
    If any format fails during script execution:
      - Capture the error in stdout/stderr.
      - Plan to record it in the log file and mention it in the final summary.

  name: Overall validate exports and write log
  description: Check that all requested formats exist, then write a small log/summary file in {output_directory}.
  action_instruction: >
    Use either a short "create and run python script" or "shell exec" combined with "create text file" to:
      - For each requested format (pdf, slides, spreadsheet):
        - Test whether the corresponding file path exists (e.g., os.path.exists).
        - Get its size in bytes (os.path.getsize) if it exists.
        - Record status = "generated" or "failed".
      - Build a small text or markdown summary string including:
        - Source: {canonical_md_path} (and original {source_file_path} if applicable).
        - Formats requested.
        - For each format: file path, status, and size (if generated).
        - Any brief error messages captured from earlier steps.
      - Write this summary to {output_directory}/{output_basename}_export_log.txt using "create text file".
  validation_instruction: >
    Confirm that:
      - The log file {output_basename}_export_log.txt exists in {output_directory}.
      - Every requested format has a corresponding status line in the log.
    If all requested formats show "generated", the task is fully successful.
    If some formats failed while others succeeded, the task can still be completed, but the final summary
    should clearly indicate partial success.

  name: Close task and report to user
  description: Inform the user which exports were created, where they are stored, and mark the task status appropriately.
  action_instruction: >
    Use "send_message" to provide a concise summary:
      - Report title: {report_title}.
      - Source used: {source_file_path} or inline content.
      - Output directory: {output_directory}.
      - Formats requested and which ones were successfully generated:
        - For each format, list the file path (e.g., {pdf_file_path}, {slides_file_path}, {spreadsheet_file_path}).
      - Path to the log file: {output_directory}/{output_basename}_export_log.txt.
      - Note any formats that could not be generated and a short explanation.
    If at least one requested format was successfully generated and the user’s main goal is satisfied:
      - Call "mark task completed" with a brief message summarizing the successful exports.
    If the user cancels before exports are generated:
      - Call "mark task cancel" with the user’s reason.
    If no requested formats could be generated due to errors:
      - Call "mark task error" with a short explanation and the log path so the user can inspect the details.

name: Document comparison and difference highlighting
description: Compare two versions of documents and produce a human-readable difference report that highlights changed, added, and removed content. Keep the flow simple: load both documents, normalize to plain text, compute differences in one script, and save the result in the workspace.

goal/outcome:
  - Two specific input documents are clearly identified as {doc_v1_path} (older/base) and {doc_v2_path} (newer/modified).
  - Both documents are successfully read and normalized into comparable plain-text form.
  - A difference report file {diff_report_path} is created in the workspace that:
    - Clearly indicates added, removed, and changed sections between the two versions.
    - Is easy for the user to read (e.g., unified diff style or side-by-side style in text/markdown).
  - The user receives a short summary of the main changes and the path of the generated difference report.
  - No original files are modified, moved, or deleted.

inputs_params:
  - Required: Path to the first document (base version) {doc_v1_path}.
  - Required: Path to the second document (new version) {doc_v2_path}.
  - Optional: Document types or formats if not clear from extension (e.g., txt, md, docx, pdf).
  - Optional: Comparison granularity:
    - line-based (default; good for most text-like docs),
    - paragraph-based,
    - or section-based if documents have clear headings.
  - Optional: Output format for the diff report:
    - plain text/markdown (default),
    - optionally Word or PDF report (if explicitly requested).
  - Optional: Character encoding hints for text files (e.g., utf-8, latin-1) if user suspects non-standard encoding.
  - Optional: Whether to include unchanged context around differences (e.g., a few lines of context).

context:
  reasoning:
    - Keep the pipeline short and efficient:
      - Confirm the two input paths and any important preferences.
      - Read each document according to its type into plain text.
      - Run a text diff in a single "create and run python script" call.
      - Save the resulting diff into one report file and summarize for the user.
    - Use specialized actions to read complex formats:
      - Use "read word file" for .docx.
      - Use "read pdf file" for PDFs.
      - Use a simple Python script to read .txt/.md or other straightforward text formats.
    - Normalize text to a consistent format (e.g., strip trailing spaces, normalize line endings) before diffing.
    - Use a standard diff method (e.g., Python difflib) to avoid re-inventing logic.
    - Prefer a simple, standard diff style (unified or side-by-side in markdown) that the user can quickly scan.
    - Only create Word/PDF output if the user explicitly asks for it; otherwise, a .txt or .md diff report is enough and cheaper.
  deadline: {time_left} left until deadline {deadline}
  definition_of_done(check during final validation step):
    - Both {doc_v1_path} and {doc_v2_path} have been successfully read to text (or user informed if one is unreadable).
    - A diff report file {diff_report_path} exists in the workspace and contains:
      - Clear indication of which content was added/removed/changed.
      - Enough context that the user can understand the changes.
    - No source document has been altered.
    - The user has received:
      - A brief explanation of the type of diff generated.
      - The path/name of the diff report.
    - If reading a document failed, the user has been informed exactly which file failed and why.
  avoid:
    - Modifying or overwriting the original documents.
    - Running multiple unnecessary passes over the documents.
    - Over-complex formatting or GUI operations for a simple text diff.
    - Producing a diff with no clear legends or markers for added/removed lines.
    - Assuming file types incorrectly; if unclear, ask the user once.

steps:
  name: Confirm documents and comparison preferences
  description: Ensure the two documents and basic diff preferences are clearly specified.
  action_instruction: >
    Use the "send_message" action to restate and confirm:
    - The path to the base/older document as {doc_v1_path}.
    - The path to the new/updated document as {doc_v2_path}.
    - Any known formats (e.g., "{doc_v1_type}", "{doc_v2_type}" such as txt, md, docx, pdf).
    - The desired diff granularity (line-based by default, or paragraph/section if they prefer).
    - The output format for the diff report (default: {diff_report_path} with .txt or .md).
    - Whether they want a unified diff (with +/- markers) or a more descriptive style (e.g., text sections labelled "Added", "Removed").
    - Whether to include a small amount of unchanged context around each difference.
    Ask the user to confirm or correct any missing/ambiguous values. If a critical detail like file path or format is unclear,
    use the "send_message" action to request that specific missing piece. After receiving answers, send a short "send_message"
    summarizing the final agreed parameters so they are explicitly recorded in the task context.
  validation_instruction: >
    Verify that:
    - {doc_v1_path} and {doc_v2_path} are non-empty strings.
    - The user has confirmed which is the base/older version and which is the new/updated version.
    - A default output diff path {diff_report_path} (e.g., {workspace}/diff_{timestamp}.md) is defined.
    If any of these are missing or conflicting (e.g., user swaps versions mid-conversation), ask again using "send_message".
    Only proceed when the inputs are consistent.

  name: Load and normalize both documents to text
  description: Read each document into plain text using the appropriate actions based on file type and normalize it for comparison.
  action_instruction: >
    For each document:
    - Decide the loading method:
      - If the file appears to be a .docx (by extension or user declaration), use "read word file" with {doc_v*_path}.
      - If the file appears to be a .pdf, use "read pdf file" with {doc_v*_path}.
      - If it is a .txt, .md, or other simple text, use "create and run python script" with a short script that:
        - Opens the file with the specified or default encoding (e.g., utf-8).
        - Reads the entire content into a string.
        - Prints it to stdout or writes it to a temporary text file.
    - Capture each documentâ€™s text as {doc_v1_text} and {doc_v2_text} (conceptually in the task state).
    - Normalize both texts in the same script or a follow-up script:
      - Normalize line endings to "\n".
      - Optionally trim trailing whitespace.
      - Optionally split into lines or paragraphs depending on the chosen granularity.
    - If any load action returns an error (e.g., unreadable PDF), send a brief "send_message" to the user identifying the problematic file and error message.
  validation_instruction: >
    Confirm that:
    - Both {doc_v1_text} and {doc_v2_text} are non-empty strings (unless the document is genuinely empty, in which case note that fact).
    - No unhandled exceptions occurred in the load/normalize steps.
    - If one document fails to load, do not proceed with diff; instead, explain the issue to the user and ask if they can provide a different file or format.

  name: Compute differences between normalized texts
  description: Run a single diff computation over the normalized texts and produce a clear in-memory diff representation.
  action_instruction: >
    Use "create and run python script" to:
    - Accept (or re-read) {doc_v1_path} and {doc_v2_path} and reload normalized text if needed, or simply embed the texts if already known.
    - Based on the chosen granularity:
      - For line-based diff:
        - Split both texts into lists of lines.
      - For paragraph-based diff:
        - Split by double newlines or other simple paragraph delimiter.
    - Use Python's difflib (e.g., unified_diff or ndiff) or an equivalent line/paragraph-based diff algorithm to generate a human-readable diff.
    - Include clear markers:
      - Lines removed from {doc_v1_path}: prefixed with "-" or labelled "REMOVED".
      - Lines added in {doc_v2_path}: prefixed with "+" or labelled "ADDED".
      - Optionally include a few unchanged context lines if requested.
    - Assemble the diff into a single text/markdown string {diff_text} that:
      - Includes a short header explaining which file is "old" and which is "new".
      - Uses standard diff legends (e.g., "old: {doc_v1_path}", "new: {doc_v2_path}").
    - Print a brief summary to stdout:
      - Approximate counts of added, removed, and changed lines/segments.
  validation_instruction: >
    Check the action output:
    - Ensure the script status is success (no unhandled exception).
    - Confirm that {diff_text} is non-empty (or clearly states "No differences found" if that is the result).
    - Confirm that the header includes both {doc_v1_path} and {doc_v2_path}.
    If the diff is empty and this is unexpected, send a short "send_message" to the user indicating that the documents appear identical based on the chosen granularity.

  name: Create diff report file
  description: Save the computed diff into a single report file in the workspace for the user to review or share.
  action_instruction: >
    Use the "create text file" action to write {diff_text} to {diff_report_path}, typically with a .txt or .md extension:
    - file_path: {diff_report_path}
    - file_content: {diff_text}
    If the user specifically asked for a Word or PDF output:
      - For Word (.docx): use "create word file" with:
        - file_path: {diff_report_docx_path}
        - content: {diff_text} in markdown-like structure.
      - For PDF: either:
        - Use "create pdf file" directly with:
          - file_path: {diff_report_pdf_path}
          - content: {diff_text} formatted as markdown/text,
        - Or use "create text file" -> "clean_to_md" -> "convert_to_pdf" if that fits better, but only if clearly requested to avoid extra steps.
    Prefer the simplest path: one diff report {diff_report_path} the user can open immediately.
  validation_instruction: >
    Confirm that:
    - "create text file" returns success status and the {diff_report_path} is reported.
    - If additional formats were requested, check that their actions also return success.
    - If any output format action fails, inform the user via "send_message" but still provide at least one successful diff report format.

  name: Close task and report comparison result
  description: Summarize the comparison outcome, provide the report path(s), and mark the task status.
  action_instruction: >
    Use "send_message" to provide a concise summary:
    - Identify the two compared documents ({doc_v1_path} as base and {doc_v2_path} as new).
    - State the comparison granularity (e.g., line-based diff).
    - Report approximate counts of added, removed, and changed segments (from the diff script output).
    - Indicate whether the documents were identical or had differences.
    - Provide the path to {diff_report_path} (and any optional {diff_report_docx_path} / {diff_report_pdf_path} if created).
    - Mention any files that could not be read and how that affected comparison.
    If everything completed successfully:
    - Call "mark task completed" with a short message summarizing success and the diff report location.
    If the user canceled or changed their mind:
    - Call "mark task cancel" with a brief reason.
    If a critical error prevented comparison (e.g., both documents unreadable):
    - Call "mark task error" with a concise explanation and any partial artifacts (like partial logs or error notes).

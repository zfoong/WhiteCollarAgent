name: Long document summarization
description: Read one or more long documents from the workspace and generate shorter summaries capturing main points, key arguments, and decisions. Use the most direct actions available to process the input files and produce a concise summary file for the user.

goal/outcome:
  - One or more input documents (e.g., .txt, .md, .docx, .pdf) in {input_directory} or at specific paths are summarized.
  - A concise, human-readable summary is created that captures:
    - Main topics and sections.
    - Key points and conclusions.
    - Decisions or action items mentioned in the source documents.
  - The summary respects user preferences for length (e.g., short, medium, detailed) and style (e.g., bullet points vs. paragraphs).
  - A summary file is saved to the workspace as {summary_output_file} (e.g., .txt, .md, or .docx).
  - The user receives a short message describing:
    - Which documents were summarized.
    - The output location and format.
    - Any documents that could not be processed.

inputs_params:
  - Required: Source location:
    - Either a directory path {input_directory} containing the documents to summarize, or
    - A list of explicit file paths {file_paths}.
  - Required: Summary style preferences:
    - Length: {summary_length}, e.g., “short overview”, “1–2 pages”, or “detailed but shorter than original”.
    - Format: {summary_format}, e.g., bullet points, structured sections, or narrative paragraphs.
  - Optional: Focus:
    - Emphasis on decisions and action items vs. general content.
    - Emphasis on specific stakeholders, topics, or sections if user indicates them.
  - Optional: Output format and location:
    - File type: {summary_file_type} (e.g., .txt, .md, .docx).
    - Output path: {summary_output_file} (default: {input_directory}/summary_{date_time}.txt).
  - Optional: Per-document vs combined summary:
    - Per-file summaries only.
    - One combined summary of all documents.
    - Both (brief per-file + overall combined).
  - Optional: Language for the summary (if different from source documents).

context:
  reasoning:
    - Keep the workflow simple:
      - Confirm which files to summarize and the desired style.
      - Use a single pass or minimal passes over the input documents.
      - Use built-in summarization actions where possible instead of complex custom logic.
    - For multiple text-like documents (.txt, .md, .docx) in a directory:
      - Prefer "batch_summarize_files" to summarize them efficiently in one action.
    - For a single long file or a small set of files:
      - Use "summarize file content" per file when appropriate.
    - For .docx and .pdf:
      - Use "read word file" or "read pdf file" if needed to extract text, then save it as a temporary .txt and summarize.
      - Only do this when necessary; avoid multi-step conversions if batch or direct summarization already works.
    - Use "combine text documents" when an overall combined summary or merged text is needed before summarizing.
    - Use "create text file" (or "create word file") for the final summary output in the requested format.
    - Keep logging and validation light: check that the summary file exists, is non-empty, and roughly matches user preferences in length and structure.
  deadline: {time_left} left until deadline {deadline}
  definition_of_done(check during final validation step):
    - All intended documents from {input_directory} or {file_paths} have either:
      - A corresponding summary entry, or
      - A clear note that they were skipped (with a reason) communicated to the user.
    - At least one summary output file {summary_output_file} exists in the workspace and is readable.
    - The summary:
      - Clearly expresses main points and conclusions.
      - Mentions key decisions or action items when present in the source.
      - Follows the user’s requested length and format as closely as practical.
    - The user has been informed of:
      - Which documents were summarized.
      - Where the summary file is located.
      - Any important limitations (e.g., unsupported file types).
  avoid:
    - Overly complex multi-stage pipelines when a single summarization action is sufficient.
    - Using GUI mode; file I/O and summarization actions are enough.
    - Processing directories or files that the user did not specify.
    - Producing a “summary” that is almost as long as the original or is mostly copied verbatim.
    - Ignoring user instructions about focus (e.g., decisions) when they are provided.

steps:
  name: Confirm documents and summary preferences
  description: Clarify which documents to summarize and how the summary should look, using a single concise exchange with the user.
  action_instruction: >
    Use "send_message" to confirm:
    - Whether the user will provide a directory {input_directory} that contains all documents
      or a list of explicit file paths {file_paths}.
    - Desired summary length (e.g., “1 paragraph per file”, “about 1 page total”, or {summary_length}).
    - Preferred format: bullets vs paragraphs vs a structured outline.
    - Whether they want:
      - One combined summary for all documents,
      - Separate summaries per document, or
      - Both.
    - Preferred output file type (e.g., .txt, .md, or .docx) and path {summary_output_file}, or accept a default.
    - Any specific focus (e.g., “only summarize decisions and action items”).
    Ask a focused "send_message" only if some critical point (like source location) is unclear, then restate the final
    parameters back to the user in a short "send_message" to lock them in the task context.
  validation_instruction: >
    Confirm that:
    - There is at least one valid-looking source location: {input_directory} or at least one {file_path}.
    - Summary length and format preferences are known (or sensible defaults chosen, e.g., short bullet summary).
    - Output format and path are decided or have a reasonable default.
    If any of these are still ambiguous, call "send_message" once more; otherwise proceed.

  name: Inspect and prepare source documents
  description: Check which documents are actually present and determine their types with minimal overhead.
  action_instruction: >
    If the user provided {input_directory}:
      - Use "list folder" with path={input_directory} to see its contents.
    If the user provided explicit {file_paths}, you can skip "list folder" and work directly from the provided list.
    From the available files:
      - Identify which are text-like formats supported directly by summarization tools (.txt, .md, .docx).
      - Note any .pdf files; these may require "read pdf file" if they are to be summarized.
      - Ignore clearly unsupported types unless the user has a special request.
    If the directory is empty or no usable documents are found, use "send_message" to inform the user and ask whether they
    want to point to a different directory or cancel.
  validation_instruction: >
    Ensure:
    - At least one suitable document is available (.txt, .md, .docx, or .pdf).
    - You have a clear list {documents_to_summarize} of files to process.
    If no suitable documents are found, explain this with "send_message" and either request new inputs or "mark task cancel"
    if the user chooses not to proceed.

  name: Summarize documents using built-in summarization actions
  description: Use the most efficient summarization action(s) available to generate per-document or combined summaries, depending on user preferences.
  action_instruction: >
    Choose the simplest effective path:
    - If the user has provided a directory {input_directory} and mostly text-like files (.txt, .md, .docx):
      - Use "batch_summarize_files" with:
        - directory_path = {input_directory},
        - output_directory = {summary_work_dir} (e.g., a subfolder or the same directory),
        - top_k, threshold, and keywords set to reasonable defaults or aligned with user focus.
      - This returns "summaries" for each document; you can assemble them later.
    - If the user has provided a single long document or a small list of files:
      - For each text-like file:
        - Use "summarize file content" with:
          - input_file = {source_file},
          - output_file = {per_file_summary_output},
          - top_k/threshold/keywords tuned to user focus (e.g., decisions).
      - For .docx files not directly handled by batch summarization:
        - Either let "batch_summarize_files" handle them if supported in your environment, or:
          - Use "read word file" to extract text to {temp_txt_file} via "create text file", then "summarize file content" on {temp_txt_file}.
      - For .pdf files:
        - Use "read pdf file" to extract text into JSON, then write main text blocks to {temp_txt_file} via "create text file", then "summarize file content" on {temp_txt_file}.
    Keep the number of actions small: prefer one "batch_summarize_files" call for many files, or a few "summarize file content"
    calls for individual documents. Avoid deep multi-stage pipelines unless strictly necessary for a specific format.
  validation_instruction: >
    Check outputs:
    - For "batch_summarize_files", confirm that "summaries" are present in the action output and that the number corresponds to
      the number of input documents you expected.
    - For "summarize file content", ensure each call produced a {summary_file} path.
    If any document fails to summarize (e.g., parsing error), mark it for mention in the final summary and continue with the rest
    unless the user indicated all-or-nothing behavior.

  name: Build final summary document
  description: Combine per-document summaries (or use batch output) into the final summary file in the requested format and structure.
  action_instruction: >
    Decide based on user preference:
    - If they want separate per-document summaries:
      - Optionally leave each {per_file_summary_output} as-is and then:
        - Use "combine text documents" on a directory containing these summary files if a single combined overview is also desired.
    - If they want a single combined summary:
      - Use "create and run python script" or "combine text documents" to:
        - Read the individual summary outputs (from "batch_summarize_files" or "summarize file content").
        - Merge them into a single in-memory string with clear headings, such as:
          - For each document: "## {file_name}" followed by bullet points or short paragraphs.
          - If requested, add a final "Overall Decisions and Actions" section summarizing cross-document decisions.
        - Write the merged content to {summary_output_file} using "create text file"
          when the desired format is .txt or .md.
      - If the user requested a .docx summary:
        - Use "create word file" with file_path={summary_output_file} and content={merged_markdown_summary}.
    Keep the structure straightforward: no complex formatting logic, just clear headings and bullet/paragraph sections aligned with
    the user’s requested format.
  validation_instruction: >
    Confirm that:
    - {summary_output_file} exists and is non-empty (you can use "shell view" to inspect the first few lines).
    - The file structure roughly matches the requested style (e.g., headings for each source document, bullets vs paragraphs).
    - If separate per-document summaries were requested, verify that their corresponding files exist as well.

  name: Overall validate summarization task
  description: Perform a quick check that the work matches the definition_of_done without excessive extra processing.
  action_instruction: >
    Using the previous step outputs:
    - Ensure that the number of summarized documents (from logs or the "summaries" output) matches the number of intended
      {documents_to_summarize}, minus any known failures.
    - Confirm the presence of {summary_output_file} and any per-file summaries promised.
    - Prepare a short internal summary of:
      - Documents processed.
      - Any documents skipped or failed.
      - Output files generated.
    If something critical is missing (e.g., no summary file produced), decide whether it can be fixed quickly
    (e.g., rerun "summarize file content" once) or needs to be reported as an error in the final step.

  name: Close task and report to user
  description: Inform the user of what was summarized, where the summary is stored, and any important notes, then mark the task appropriately.
  action_instruction: >
    Use "send_message" to provide a concise summary:
    - List the main source location(s): {input_directory} or {file_paths}.
    - State whether the summaries are:
      - Per-document,
      - One combined summary, or
      - Both.
    - Specify:
      - The path and format of {summary_output_file}.
      - Any additional per-file summary outputs if they exist.
    - Briefly describe the focus (e.g., “main points and decisions”) and approximate length.
    - Mention any documents that could not be processed and why.
    If the summaries have been successfully created:
      - Call "mark task completed" with a short message referencing {summary_output_file}.
    If the user canceled after seeing that no suitable documents were found:
      - Call "mark task cancel" with the reason.
    If the summarization repeatedly failed or the output could not be generated as requested:
      - Call "mark task error" with a brief description and indicate any partial summary files that do exist.

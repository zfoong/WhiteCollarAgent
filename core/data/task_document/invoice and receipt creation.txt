name: Invoice and receipt creation
description: Use simple templates and provided line items/client details to generate invoices or receipts as files (Word or PDF) in the workspace, with correct totals and clear formatting, via a small number of efficient actions.

goal/outcome:
  - One or more invoices/receipts generated from user-provided data and saved to the workspace at {output_directory}.
  - Each document includes at minimum: issuer details, client details, document header (Invoice/Receipt), unique number, date, line items, subtotals, taxes/discounts (if any), total amount, and payment/notes section.
  - Line item calculations (quantity × unit price, tax, discounts) are correct and consistent with the supplied rules.
  - File naming clearly identifies the document, such as {client_name}_{invoice_or_receipt}_{invoice_number}.docx or .pdf.
  - The user receives a short summary listing the generated files, key amounts, and where the documents are stored.

inputs_params:
  - Required: Document type: "invoice" or "receipt".
  - Required: Client details:
    - {client_name}
    - {client_address}
    - Optional: {client_email}, {client_phone}, {client_tax_id}
  - Required: Issuer details:
    - {issuer_name}
    - {issuer_address}
    - Optional: {issuer_email}, {issuer_phone}, {issuer_tax_id}, {issuer_logo_path} (if used by a template).
  - Required: Line items as structured data (or clearly described):
    - Each line item: {description}, {quantity}, {unit_price}, optional {tax_rate}, optional {discount}.
  - Required: Currency code or symbol, e.g., {currency} = "USD", "EUR", "¥".
  - Required: Document meta:
    - {invoice_number} or {receipt_number}
    - {issue_date} and optional {due_date}
  - Optional: Tax/discount rules:
    - Global tax rate or per-line tax.
    - Global discount or per-line discount.
  - Optional: Template preference:
    - Use a simple built-in template (default), or
    - Use a user-provided template description or file path {template_file_path} (structure/layout).
  - Optional: Output format preference:
    - "pdf", "docx", or both.
  - Optional: Output directory path in workspace: {output_directory} (default: a sensible workspace folder such as ./invoices or ./receipts).
  - Optional: Language/locale and date/number formatting preferences (e.g., DD/MM/YYYY vs YYYY-MM-DD, decimal separators).

context:
  reasoning:
    - Keep the workflow short and predictable: confirm data and format → compute totals → render document content → create file(s) → quick check and summary.
    - Prefer generating a single well-structured text representation (e.g., Markdown-like or plain text with clear sections) and then passing it into file creation actions.
    - For non-trivial totals (many items, taxes, discounts), it is safer to use a single "create and run python script" or "calculate math expression" call to compute subtotals, tax amounts, and grand total in one place.
    - Use "create word file" or "create pdf file" directly with the prepared content instead of chaining multiple conversions unless the user explicitly asks for a specific format chain.
    - Use simple placeholders in the content ({client_name}, {invoice_number}, {total_amount}, etc.) and fill them based on the confirmed inputs in one pass.
    - Avoid unnecessary external lookups or complex template engines; rely on straightforward text formatting to minimize actions and errors.
  deadline: {time_left} left until deadline {deadline}
  definition_of_done(check during final validation step):
    - At least one document has been created at an expected path under {output_directory}.
    - Key numeric fields (line totals, subtotals, tax, grand total) are consistent with the supplied data and rules.
    - The document clearly shows who is billing/issuing, who is being billed, document number, date, and a clear total.
    - The file name(s) and type(s) match the user’s requested format(s).
    - The user has received a short summary listing file paths and total amounts, and no critical data field is obviously missing.
  avoid:
    - Making assumptions about tax or discounts without the user specifying them.
    - Adding extra fields (e.g., legal language, custom terms) unless requested.
    - Creating multiple intermediate files unless truly needed.
    - Using GUI mode; CLI-based file creation is sufficient.
    - Overcomplicating templating (no heavy template engines or multi-pass layout unless user provides them).

steps:
  name: Confirm invoice/receipt parameters
  description: Clarify what to generate (invoice or receipt), for whom, and with which data and format, using minimal back-and-forth.
  action_instruction: >
    Use "send_message" to summarize and ask the user to confirm or provide:
    - Document type: invoice or receipt.
    - Client details: {client_name}, {client_address}, and any extra identifiers (email, tax ID) they care about.
    - Issuer details: {issuer_name}, {issuer_address}, and any extra identifiers.
    - Line items: a list of {description, quantity, unit_price}, and optionally {tax_rate}, {discount} for each or global values.
    - Currency: e.g., {currency} = "USD", "EUR", "JPY".
    - Document meta: {invoice_number}/{receipt_number}, {issue_date}, optional {due_date}.
    - Tax/discount logic: global vs per-line and whether totals should show tax separately.
    - Output format(s): "pdf", "docx", or both.
    - Output directory: {output_directory} (default to a simple workspace directory like ./invoices or ./receipts).
    - Whether they have a specific layout/template (e.g., "simple table layout" or a template file at {template_file_path}) or are fine with a simple standard layout.
    If any core piece is missing (like line items or client details), use "send_message" with a focused prompt, then restate the final, agreed parameters with another short "send_message" so they are explicit in the history.
  validation_instruction: >
    Ensure the following are clearly defined before proceeding:
    - Document type (invoice/receipt).
    - At least one line item with valid quantity and unit_price values.
    - Client and issuer names.
    - Currency and document number.
    - At least one output format (pdf/docx).
    If any of these are unclear or missing, ask again using "send_message". Proceed once the user’s confirmation is explicit.

  name: Compute totals and normalize line item data
  description: Turn the user’s line items into a clean, consistent internal representation with correct totals, subtotals, and taxes/discounts.
  action_instruction: >
    Use "create and run python script" (or "calculate math expression" if very simple) to:
    - Embed the confirmed line item data and tax/discount rules as a Python data structure (e.g., a list of dicts).
    - For each line item:
      - Normalize quantity and unit_price to numeric types.
      - Compute line_total = quantity * unit_price.
      - Apply per-line tax and/or discount if provided, tracking these amounts.
    - Compute:
      - subtotal = sum of line_total values (before tax/discount).
      - total_tax_amount and total_discount_amount (if applicable).
      - grand_total = subtotal + total_tax_amount - total_discount_amount.
    - Prepare a small JSON-like or CSV-ready string that contains:
      - Normalized line items with computed line_total.
      - subtotal, total_tax_amount, total_discount_amount, grand_total, currency.
    - Print the key totals (subtotal, tax, grand total) to stdout for quick inspection.
    The script does not need to write a file unless convenient; its main output is the computed totals and normalized items used to build the document content in the next step.
  validation_instruction: >
    Check the script output:
    - Confirm that there are no exceptions and status indicates success.
    - Verify that subtotal and grand_total values look reasonable (e.g., not negative unless explicitly expected).
    - If any line item cannot be parsed (e.g., invalid numbers), use "send_message" to explain which item failed and ask the user to correct it or confirm how to handle it (e.g., skip or fix values) before rerunning this step.

  name: Generate invoice/receipt document content
  description: Build a clean, structured text layout for the invoice/receipt using either a simple built-in template structure or a user-specified template, ready to be passed to a file creation action.
  action_instruction: >
    Based on confirmed parameters and computed totals, construct the full document content in a single pass (within the LLM), using a simple layout such as:
    - Header:
      - {issuer_name}, address, contact info.
      - Document title: "INVOICE" or "RECEIPT".
      - {invoice_number}/{receipt_number}, {issue_date}, {due_date} if any.
    - Client section:
      - "Bill To" or "Received From": {client_name}, {client_address}, and any identifiers.
    - Line items table:
      - Columns: Item, Quantity, Unit Price ({currency}), Line Total ({currency}).
      - Rows from normalized line items, with line_total values filled.
    - Summary section:
      - Subtotal.
      - Tax breakdown if applicable.
      - Discounts if applicable.
      - Grand Total ({currency}).
    - Payment/notes section:
      - Payment terms, reference notes, or a short text from the user if provided.
    - Footer (optional): {issuer_tax_id}, thank-you note, any simple legal remark the user asked to include.
    If the user provided a template description or file path, align headings and sections with that template as closely as is reasonable, but keep it simple (no complex template engine).
    Once the content string is prepared (e.g., Markdown-like or plain text with clear headings and table formatting), proceed directly to file creation.
  validation_instruction: >
    Quickly self-check that:
    - All essential fields (client, issuer, document number, date, line items, total) are present in the content.
    - Totals in the content match the values computed in the previous step.
    - The document title matches the requested type (INVOICE vs RECEIPT).
    If any core piece is missing, adjust the content before creating files.

  name: Create output file(s)
  description: Create the requested invoice/receipt files (PDF, Word, or both) in the workspace using the prepared content.
  action_instruction: >
    Decide on the simplest pipeline based on requested format:
    - If the user wants a Word document (.docx):
      - Call "create word file" with:
        - file_path = {output_directory}/{client_name}_{invoice_or_receipt}_{invoice_number}.docx
        - content = the prepared Markdown-like content.
    - If the user wants a PDF:
      - Either:
        - Call "create pdf file" directly with:
          - file_path = {output_directory}/{client_name}_{invoice_or_receipt}_{invoice_number}.pdf
          - content = the same prepared content; or
        - If you already produced a .docx and the environment favors conversion, optionally call "convert_to_pdf" using the docx as input and an appropriate output_pdf path.
    Ensure {output_directory} exists, creating it via "create folder" if needed, before writing files.
  validation_instruction: >
    After creation:
    - Check the returned status fields from "create word file" and/or "create pdf file" to ensure success.
    - Confirm that the returned path(s) match the expected naming pattern and directory.
    - If file creation fails (e.g., invalid path or permissions), send a short "send_message" describing the issue and either:
      - Retry with a simpler path/name, or
      - Ask the user for an alternative {output_directory} before trying again.

  name: Close task and report to user
  description: Provide the user with a concise summary of the generated invoice(s)/receipt(s), including file locations and key amounts, and mark the task status.
  action_instruction: >
    Use "send_message" to summarize:
    - Document type (invoice/receipt).
    - Client and issuer names.
    - Invoice/receipt number and issue date (and due date if present).
    - Grand total and currency.
    - Output format(s) created (.pdf, .docx) and their file paths in the workspace (e.g., {invoice_file_path}, {receipt_file_path}).
    - Any notable tax/discount applied.
    If everything succeeded:
      - Call "mark task completed" with a brief message indicating that the invoices/receipts were generated and where they are stored.
    If the user cancels midway (e.g., changes requirements and no document should be created):
      - Call "mark task cancel" with a short reason.
    If repeated errors prevent creating valid files (e.g., persistent path or content issues that cannot be resolved here):
      - Call "mark task error" explaining the failure and pointing to any partial files or notes that were created.
